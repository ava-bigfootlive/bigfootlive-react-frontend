<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Chat Test</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <h1>WebSocket Chat Test</h1>
    <div id="status">Disconnected</div>
    <div id="messages" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0;"></div>
    <input type="text" id="messageInput" placeholder="Type a message..." style="width: 300px;">
    <button onclick="sendMessage()">Send</button>
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>

    <script>
        let socket = null;
        const eventId = 'demo-1';
        
        function updateStatus(status) {
            document.getElementById('status').innerText = status;
        }
        
        function addMessage(msg) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.innerText = `${new Date().toLocaleTimeString()}: ${msg}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function connect() {
            // Try connecting to the WebSocket server
            const wsUrl = 'wss://api.bigfootlive.io';
            
            socket = io(wsUrl, {
                path: '/socket.io/',
                transports: ['websocket'],
                reconnection: true,
                auth: {
                    token: 'test-token' // In real app, this would be the Cognito token
                }
            });
            
            socket.on('connect', () => {
                updateStatus('Connected');
                addMessage('Connected to server');
                // Join event chat room
                socket.emit('join:event', { eventId });
            });
            
            socket.on('disconnect', () => {
                updateStatus('Disconnected');
                addMessage('Disconnected from server');
            });
            
            socket.on('error', (error) => {
                addMessage(`Error: ${error}`);
            });
            
            socket.on('chat:message', (data) => {
                addMessage(`${data.username}: ${data.content}`);
            });
            
            socket.on('chat:typing', (data) => {
                if (data.isTyping) {
                    addMessage(`${data.username} is typing...`);
                }
            });
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            if (socket && socket.connected && input.value) {
                socket.emit('chat:send', {
                    eventId,
                    message: input.value,
                    timestamp: Date.now()
                });
                addMessage(`You: ${input.value}`);
                input.value = '';
            }
        }
        
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Try native WebSocket as fallback
        function connectNative() {
            const ws = new WebSocket('wss://api.bigfootlive.io/ws/chat/' + eventId);
            
            ws.onopen = () => {
                updateStatus('Connected (Native WS)');
                addMessage('Connected via native WebSocket');
            };
            
            ws.onmessage = (event) => {
                addMessage(`Received: ${event.data}`);
            };
            
            ws.onerror = (error) => {
                addMessage(`WebSocket error: ${error}`);
            };
            
            ws.onclose = () => {
                updateStatus('Disconnected (Native WS)');
                addMessage('WebSocket closed');
            };
            
            return ws;
        }
    </script>
</body>
</html>