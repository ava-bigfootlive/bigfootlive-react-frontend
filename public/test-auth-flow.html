<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Flow Test</title>
  <style>
    body { 
      font-family: monospace; 
      padding: 20px; 
      background: #1a1a1a; 
      color: #fff;
    }
    button { 
      padding: 10px 20px; 
      margin: 5px; 
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #45a049; }
    .error { color: #ff6b6b; }
    .success { color: #51cf66; }
    pre { 
      background: #2a2a2a; 
      padding: 10px; 
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Authentication Flow Test</h1>
  
  <div>
    <h2>Step 1: Check localStorage for tokens</h2>
    <button onclick="checkLocalStorage()">Check localStorage</button>
    <pre id="localStorage-output"></pre>
  </div>

  <div>
    <h2>Step 2: Test Backend API</h2>
    <button onclick="testBackendHealth()">Test Health (No Auth)</button>
    <button onclick="testBackendAuth()">Test Auth Endpoint</button>
    <button onclick="testBackendEvents()">Test Events Endpoint</button>
    <pre id="api-output"></pre>
  </div>

  <div>
    <h2>Step 3: Decode Token</h2>
    <button onclick="decodeToken()">Decode Current Token</button>
    <pre id="token-output"></pre>
  </div>

  <script>
    const CLIENT_ID = '1vk1puqortjm4kk08kh0u1otaj';
    const API_URL = 'https://api.bigfootlive.io';

    function log(message, type = 'info') {
      const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#fff';
      console.log(`%c${message}`, `color: ${color}`);
    }

    function checkLocalStorage() {
      const output = document.getElementById('localStorage-output');
      const cognitoKeys = Object.keys(localStorage).filter(key => 
        key.includes('CognitoIdentityServiceProvider')
      );
      
      const lastUser = localStorage.getItem(`CognitoIdentityServiceProvider.${CLIENT_ID}.LastAuthUser`);
      
      let result = `Found ${cognitoKeys.length} Cognito keys\n`;
      result += `Last authenticated user: ${lastUser || 'None'}\n\n`;
      
      if (lastUser) {
        const accessTokenKey = `CognitoIdentityServiceProvider.${CLIENT_ID}.${lastUser}.accessToken`;
        const idTokenKey = `CognitoIdentityServiceProvider.${CLIENT_ID}.${lastUser}.idToken`;
        const refreshTokenKey = `CognitoIdentityServiceProvider.${CLIENT_ID}.${lastUser}.refreshToken`;
        
        const accessToken = localStorage.getItem(accessTokenKey);
        const idToken = localStorage.getItem(idTokenKey);
        const refreshToken = localStorage.getItem(refreshTokenKey);
        
        result += `Access Token: ${accessToken ? '✓ Present' : '✗ Missing'}\n`;
        result += `ID Token: ${idToken ? '✓ Present' : '✗ Missing'}\n`;
        result += `Refresh Token: ${refreshToken ? '✓ Present' : '✗ Missing'}\n`;
        
        if (accessToken) {
          result += `\nAccess Token (first 50 chars): ${accessToken.substring(0, 50)}...\n`;
        }
      }
      
      output.textContent = result;
    }

    function getAccessToken() {
      const lastUser = localStorage.getItem(`CognitoIdentityServiceProvider.${CLIENT_ID}.LastAuthUser`);
      if (!lastUser) return null;
      
      const accessTokenKey = `CognitoIdentityServiceProvider.${CLIENT_ID}.${lastUser}.accessToken`;
      return localStorage.getItem(accessTokenKey);
    }

    async function testBackendHealth() {
      const output = document.getElementById('api-output');
      output.textContent = 'Testing health endpoint...\n';
      
      try {
        const response = await fetch(`${API_URL}/health`);
        const data = await response.json();
        output.textContent = `Health Status: ${response.status}\n${JSON.stringify(data, null, 2)}`;
        log('Health check successful', 'success');
      } catch (error) {
        output.textContent = `Error: ${error.message}`;
        log('Health check failed', 'error');
      }
    }

    async function testBackendAuth() {
      const output = document.getElementById('api-output');
      const token = getAccessToken();
      
      if (!token) {
        output.textContent = 'No access token found. Please log in first.';
        return;
      }
      
      output.textContent = 'Testing auth endpoint with token...\n';
      
      try {
        const response = await fetch(`${API_URL}/api/auth/me`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        output.textContent = `Auth Status: ${response.status}\n`;
        
        if (response.ok) {
          const data = await response.json();
          output.textContent += JSON.stringify(data, null, 2);
          log('Auth test successful', 'success');
        } else {
          const error = await response.text();
          output.textContent += `Error: ${error}`;
          log('Auth test failed', 'error');
        }
      } catch (error) {
        output.textContent = `Error: ${error.message}`;
        log('Auth test failed', 'error');
      }
    }

    async function testBackendEvents() {
      const output = document.getElementById('api-output');
      const token = getAccessToken();
      
      if (!token) {
        output.textContent = 'No access token found. Please log in first.';
        return;
      }
      
      output.textContent = 'Testing events endpoint with token...\n';
      
      try {
        const response = await fetch(`${API_URL}/api/v1/events`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        output.textContent = `Events Status: ${response.status}\n`;
        
        if (response.ok) {
          const data = await response.json();
          output.textContent += JSON.stringify(data, null, 2);
          log('Events test successful', 'success');
        } else {
          const error = await response.text();
          output.textContent += `Error: ${error}`;
          log('Events test failed', 'error');
        }
      } catch (error) {
        output.textContent = `Error: ${error.message}`;
        log('Events test failed', 'error');
      }
    }

    function decodeToken() {
      const output = document.getElementById('token-output');
      const token = getAccessToken();
      
      if (!token) {
        output.textContent = 'No access token found';
        return;
      }
      
      try {
        // JWT has 3 parts separated by dots
        const parts = token.split('.');
        if (parts.length !== 3) {
          throw new Error('Invalid JWT format');
        }
        
        // Decode header and payload
        const header = JSON.parse(atob(parts[0]));
        const payload = JSON.parse(atob(parts[1]));
        
        // Check expiration
        const exp = payload.exp;
        const now = Math.floor(Date.now() / 1000);
        const isExpired = exp < now;
        const expiresIn = exp - now;
        
        output.textContent = `Token Header:\n${JSON.stringify(header, null, 2)}\n\n`;
        output.textContent += `Token Payload:\n${JSON.stringify(payload, null, 2)}\n\n`;
        output.textContent += `Token Status:\n`;
        output.textContent += `- Expired: ${isExpired ? 'YES ❌' : 'NO ✓'}\n`;
        output.textContent += `- Expires in: ${expiresIn > 0 ? `${Math.floor(expiresIn / 60)} minutes` : 'EXPIRED'}\n`;
        output.textContent += `- Issued: ${new Date(payload.iat * 1000).toLocaleString()}\n`;
        output.textContent += `- Expires: ${new Date(payload.exp * 1000).toLocaleString()}`;
        
      } catch (error) {
        output.textContent = `Error decoding token: ${error.message}`;
      }
    }

    // Check on load
    window.onload = () => {
      checkLocalStorage();
    };
  </script>
</body>
</html>